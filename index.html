<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LenceriaShops - Cat√°logo</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/gkJx4YM/Generated-Image-November-20-2025-12-39-AM.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/gkJx4YM/Generated-Image-November-20-2025-12-39-AM.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LenceriaShops">
    <meta name="theme-color" content="#d4a574">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #d4a574;
            --secondary: #f5e6d3;
            --dark: #2c1810;
            --bg: #faf8f5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            padding: 10px 0;
        }
        .navbar-brand {
            font-size: 1.3rem;
            font-weight: 400;
            letter-spacing: 1.5px;
            color: white !important;
        }
        .hero-section {
            background: linear-gradient(135deg, rgba(212,165,116,0.1), rgba(245,230,211,0.3));
            padding: 12px 0 10px;
            text-align: center;
        }
        .hero-section h1 { font-size: 1.2rem; font-weight: 400; color: var(--dark); }
        .hero-section p { font-size: 0.8rem; color: #666; margin: 2px 0 0; }
        .category-filters {
            background: white;
            padding: 10px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .filter-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        .filter-btn {
            background: white;
            border: 1.5px solid var(--primary);
            color: var(--primary);
            padding: 4px 11px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .filter-btn.active, .filter-btn:active {
            background: var(--primary);
            color: white;
        }
        .content-section { flex: 1; padding: 10px 0 70px; }
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s;
            height: 100%;
            position: relative;
        }
        .product-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: var(--secondary);
            display: block;
        }
        .product-image.sold { opacity: 0.65; filter: grayscale(30%); }
        .product-body { padding: 10px; }
        .product-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; line-height: 1.3; }
        .product-desc { font-size: 0.72rem; color: #888; margin-bottom: 4px; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { font-size: 1.05rem; color: var(--primary); font-weight: 700; margin-bottom: 6px; }
        .size-badge {
            background: var(--secondary);
            color: var(--dark);
            padding: 2px 7px;
            border-radius: 8px;
            font-size: 0.68rem;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 6px;
        }
        .stock-badge {
            display: block;
            padding: 2px 0;
            font-size: 0.7rem;
            margin-bottom: 7px;
        }
        .stock-available { color: #155724; }
        .stock-low { color: #856404; }
        .sold-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            padding: 3px 9px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 5;
            transform: rotate(4deg);
        }
        .btn-buy {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-buy:disabled { background: #aaa; cursor: not-allowed; }
        .loading-spinner { display: none; text-align: center; padding: 30px; }
        .no-products { text-align: center; padding: 30px; color: #999; }
        .no-products i { font-size: 2.5rem; display: block; margin-bottom: 10px; }
        .whatsapp-btn {
            position: fixed;
            bottom: 72px;
            right: 15px;
            background: #25d366;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 14px rgba(37,211,102,0.45);
            text-decoration: none;
            z-index: 900;
        }
        .footer {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            text-align: center;
            padding: 10px 0;
        }
        .footer small { font-size: 0.72rem; }
        .footer a { color: white; text-decoration: none; font-weight: 500; }
        .pagination-container { display: flex; justify-content: center; margin-top: 16px; }
        .pagination .page-link { color: var(--primary); border-color: var(--primary); padding: 5px 10px; font-size: 0.82rem; }
        .pagination .page-item.active .page-link { background: var(--primary); border-color: var(--primary); color: white; }

        /* Modal mobile */
        .modal-content { border-radius: 16px; border: none; }
        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 12px 16px;
        }
        .modal-title { font-size: 1rem; }
        .modal-body { padding: 14px; }
        .modal-footer { padding: 10px 14px; }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 8px 10px;
            font-size: 0.85rem;
        }
        .form-label { font-size: 0.82rem; font-weight: 500; margin-bottom: 3px; }
        .form-text-transform-hint { font-size: 0.7rem; color: #999; margin-top: 2px; }
        .payment-option {
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .payment-option.selected { border-color: var(--primary); background: rgba(212,165,116,0.06); }
        .form-check-label strong { font-size: 0.85rem; }
        .form-check-label p { font-size: 0.75rem; }
        .financing-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            display: none;
            font-size: 0.82rem;
        }
        .financing-details.show { display: block; }
        .financing-details .h5 { font-size: 1rem; }
        .alert { font-size: 0.8rem; padding: 8px 12px; }

        @media (max-width: 767px) {
            .modal-dialog { margin: 10px; }
            .modal-content { border-radius: 14px; }
            .product-image { height: 140px; }
            .product-body { padding: 8px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shop"></i> LenceriaShops
            </a>
        </div>
    </nav>

    <section class="hero-section">
        <div class="container">
            <h1>Cat√°logo de Lencer√≠a Premium</h1>
            <p>Colecci√≥n exclusiva por tama√±os</p>
        </div>
    </section>

    <section class="content-section">
        <div class="container-fluid px-2">
            <div class="category-filters mb-2" style="border-radius:0;">
                <div class="filter-buttons-container">
                    <button class="filter-btn active" onclick="filterBySize('all', this)">
                        <i class="bi bi-grid-3x3-gap"></i> Todos
                    </button>
                    <button class="filter-btn" onclick="filterBySize('sabanas', this)">
                        <i class="bi bi-rulers"></i> Individual
                    </button>
                    <button class="filter-btn" onclick="filterBySize('cubrecamas', this)">
                        <i class="bi bi-arrows-angle-expand"></i> Matrimonial
                    </button>
                    <button class="filter-btn" onclick="filterBySize('almohadas', this)">
                        <i class="bi bi-arrows-fullscreen"></i> Queen
                    </button>
                    <button class="filter-btn" onclick="filterBySize('fundas', this)">
                        <i class="bi bi-aspect-ratio"></i> King
                    </button>
                </div>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border" style="color:var(--primary)" role="status"></div>
                <p class="mt-2 small">Cargando productos...</p>
            </div>

            <div class="row g-2 px-1" id="productsContainer"></div>

            <div class="pagination-container" id="paginationContainer"></div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <small>&copy; 2024 LenceriaShops | <a href="https://www.instagram.com/inkgstar" target="_blank">gstarINK</a></small>
        </div>
    </footer>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-bag-check"></i> Completar Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <input type="hidden" id="productId">
                        <input type="hidden" id="productPrice">
                        <input type="hidden" id="productName">

                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Apellido *</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="whatsapp" placeholder="+58 422XXXXXXX" required>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">Edificio *</label>
                                <input type="text" class="form-control text-uppercase" id="building" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Apartamento *</label>
                                <input type="text" class="form-control text-uppercase" id="apartment" required>
                            </div>
                        </div>

                        <div class="mb-1">
                            <label class="form-label">M√©todo de Pago *</label>
                            <div class="payment-option" onclick="this.querySelector('input').click()">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFull" value="full" required>
                                    <label class="form-check-label" for="paymentFull">
                                        <strong>Pago Completo</strong>
                                        <p class="mb-0 text-muted">Total del producto</p>
                                    </label>
                                </div>
                            </div>
                            <div class="payment-option" onclick="this.querySelector('input').click()">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFinancing" value="financing">
                                    <label class="form-check-label" for="paymentFinancing">
                                        <strong>Financiamiento</strong>
                                        <p class="mb-0 text-muted">Inicial + cuotas quincenales</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="financing-details" id="financingDetails">
                            <h6 class="mb-2">Detalles del Financiamiento</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted d-block">Inicial</small>
                                    <span class="h5" style="color:var(--primary)" id="initialAmount">$0</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Cuota 1</small>
                                    <span class="h5" style="color:var(--primary)" id="quota1">$0</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Cuota 2</small>
                                    <span class="h5" style="color:var(--primary)" id="quota2">$0</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-2 mb-0">
                            <i class="bi bi-info-circle"></i> Ser√°s redirigido a WhatsApp para confirmar.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm" id="confirmPurchase" style="background:var(--primary);color:white;border:none;border-radius:8px;padding:7px 16px;">
                        <i class="bi bi-whatsapp"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <a href="https://wa.me/584129204453?text=Hola%20LenceriaShops%2C%20necesito%20ayuda." target="_blank" class="whatsapp-btn">
        <i class="bi bi-headset"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =====================================================
        // JSONBin.io Configuration
        // REEMPLAZA los IDs de los bins con los tuyos
        // =====================================================
        const DB = {
            key: '$2a$10$.8.yyKcPSDxyqhB3HXGfRO0vfwIxCo/nKu18i.U8/N78AauRqJhre',
            bins: {
                productos:    '699e7bf7d0ea881f40d6e62e',   // ‚Üê reemplaza
                compras:      '699e7bd143b1c97be99b7d65',     // ‚Üê reemplaza
                cuotas:       '699e7be4d0ea881f40d6e603',      // ‚Üê reemplaza
                config:       '699e7bf7d0ea881f40d6e62e'        // ‚Üê reemplaza
            },
            baseUrl: 'https://api.jsonbin.io/v3/b',
            async get(bin) {
                const r = await fetch(`${this.baseUrl}/${this.bins[bin]}/latest`, {
                    headers: { 'X-Master-Key': this.key }
                });
                if (!r.ok) throw new Error('Error leyendo ' + bin);
                return (await r.json()).record;
            },
            async set(bin, data) {
                const r = await fetch(`${this.baseUrl}/${this.bins[bin]}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': this.key },
                    body: JSON.stringify(data)
                });
                if (!r.ok) throw new Error('Error escribiendo ' + bin);
                return (await r.json()).record;
            }
        };

        const uid = () => Date.now() * 1000 + Math.floor(Math.random() * 999);

        // =====================================================
        // Global state
        // =====================================================
        let currentProduct = null;
        let financingConfig = { monto_inicial: 10, numero_cuotas: 2, dias_cuota: 15 };
        let allProducts = [];
        let currentFilter = 'all';
        let currentPage = 1;
        const productsPerPage = 12;

        const sizeMapping = {
            'sabanas': 'Individual',
            'cubrecamas': 'Matrimonial',
            'almohadas': 'Queen',
            'fundas': 'King'
        };

        // =====================================================
        // Init
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadFinancingConfig();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.querySelectorAll('input[name="paymentType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                    this.closest('.payment-option').classList.add('selected');
                    if (this.value === 'financing') showFinancingDetails();
                    else hideFinancingDetails();
                });
            });

            document.getElementById('confirmPurchase').addEventListener('click', processPurchase);

            document.getElementById('whatsapp').addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 0 && !v.startsWith('58')) v = '58' + v;
                if (v.length >= 4) v = '+' + v.slice(0, 3) + ' ' + v.slice(3);
                e.target.value = v;
            });

            document.getElementById('firstName').addEventListener('input', function(e) {
                const v = e.target.value;
                if (v) e.target.value = v.charAt(0).toUpperCase() + v.slice(1).toLowerCase();
            });
            document.getElementById('lastName').addEventListener('input', function(e) {
                const v = e.target.value;
                if (v) e.target.value = v.charAt(0).toUpperCase() + v.slice(1).toLowerCase();
            });
            document.getElementById('building').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
            document.getElementById('apartment').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
        }

        // =====================================================
        // Load products from JSONBin
        // =====================================================
        async function loadProducts() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('productsContainer').innerHTML = '';
                const rec = await DB.get('productos');
                allProducts = (rec.productos || []).sort((a, b) => a.nombre.localeCompare(b.nombre));
                displayProducts();
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (err) {
                console.error(err);
                document.getElementById('loadingSpinner').innerHTML =
                    '<p class="text-danger small">Error al cargar. Recargue la p√°gina.</p>';
            }
        }

        // =====================================================
        // Load financing config from JSONBin
        // =====================================================
        async function loadFinancingConfig() {
            try {
                const rec = await DB.get('config');
                financingConfig = rec.configuracion?.financiamiento || { monto_inicial: 10, numero_cuotas: 2, dias_cuota: 15 };
            } catch {
                financingConfig = { monto_inicial: 10, numero_cuotas: 2, dias_cuota: 15 };
            }
        }

        // =====================================================
        // Filter
        // =====================================================
        function filterBySize(size, el) {
            currentFilter = size;
            currentPage = 1;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            displayProducts();
        }

        // =====================================================
        // Display products
        // =====================================================
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            const filtered = currentFilter === 'all'
                ? allProducts
                : allProducts.filter(p => p.categoria === currentFilter);

            const totalPages = Math.ceil(filtered.length / productsPerPage);
            const start = (currentPage - 1) * productsPerPage;
            const toShow = filtered.slice(start, start + productsPerPage);

            if (toShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12 no-products">
                        <i class="bi bi-inbox"></i>
                        <p>No hay productos disponibles</p>
                        <small class="text-muted">Prueba otra categor√≠a</small>
                    </div>`;
            } else {
                container.innerHTML = '';
                toShow.forEach(product => {
                    const isSold = !product.activo;
                    const sizeName = sizeMapping[product.categoria] || product.categoria;
                    const nameEscaped = product.nombre.replace(/'/g, "\\'");
                    container.innerHTML += `
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="product-card">
                                ${isSold ? '<div class="sold-badge">VENDIDO</div>' : ''}
                                <img src="${product.imagen || 'https://picsum.photos/seed/ls' + product.id + '/400/300'}"
                                     alt="${product.nombre}" class="product-image ${isSold ? 'sold' : ''}"
                                     loading="lazy">
                                <div class="product-body">
                                    <div class="product-title">${product.nombre}</div>
                                    <div class="product-desc">${product.descripcion || ''}</div>
                                    <span class="size-badge">${sizeName}</span>
                                    <div class="product-price">$${parseFloat(product.precio).toFixed(2)}</div>
                                    ${isSold
                                        ? '<span class="stock-badge stock-low">Producto vendido</span>'
                                        : (product.stock > 5
                                            ? '<span class="stock-badge stock-available">‚úì Disponible</span>'
                                            : `<span class="stock-badge stock-low">¬°Solo ${product.stock}!</span>`)
                                    }
                                    <button class="btn-buy" onclick="openPurchaseModal(${product.id}, '${nameEscaped}', ${product.precio})"
                                            ${isSold || product.stock <= 0 ? 'disabled' : ''}>
                                        <i class="bi bi-cart-plus"></i> ${isSold ? 'No disponible' : 'Comprar'}
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
            }
            updatePagination(totalPages);
        }

        function updatePagination(totalPages) {
            const pc = document.getElementById('paginationContainer');
            if (totalPages <= 1) { pc.innerHTML = ''; return; }
            let html = '<nav><ul class="pagination pagination-sm">';
            if (currentPage > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1});return false;"><i class="bi bi-chevron-left"></i></a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="changePage(${i});return false;">${i}</a></li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
            }
            if (currentPage < totalPages) html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1});return false;"><i class="bi bi-chevron-right"></i></a></li>`;
            html += '</ul></nav>';
            pc.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            displayProducts();
            document.querySelector('.content-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // =====================================================
        // Purchase Modal
        // =====================================================
        function openPurchaseModal(productId, productName, productPrice) {
            currentProduct = { id: productId, name: productName, price: productPrice };
            document.getElementById('productId').value = productId;
            document.getElementById('productName').value = productName;
            document.getElementById('productPrice').value = productPrice;
            document.getElementById('purchaseForm').reset();
            document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
            hideFinancingDetails();
            new bootstrap.Modal(document.getElementById('purchaseModal')).show();
        }

        function showFinancingDetails() {
            const price = parseFloat(document.getElementById('productPrice').value);
            const init = financingConfig.monto_inicial;
            const quota = (price - init) / financingConfig.numero_cuotas;
            document.getElementById('initialAmount').textContent = `$${init.toFixed(2)}`;
            document.getElementById('quota1').textContent = `$${quota.toFixed(2)}`;
            document.getElementById('quota2').textContent = `$${quota.toFixed(2)}`;
            document.getElementById('financingDetails').classList.add('show');
        }

        function hideFinancingDetails() {
            document.getElementById('financingDetails').classList.remove('show');
        }

        // =====================================================
        // Process Purchase ‚Üí Save to JSONBin
        // =====================================================
        async function processPurchase() {
            const form = document.getElementById('purchaseForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const btn = document.getElementById('confirmPurchase');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            const purchaseCode = generatePurchaseCode();
            const formData = {
                id: uid(),
                producto_id: currentProduct.id,
                nombre: document.getElementById('firstName').value,
                apellido: document.getElementById('lastName').value,
                whatsapp: document.getElementById('whatsapp').value,
                edificio: document.getElementById('building').value,
                apartamento: document.getElementById('apartment').value,
                tipo_pago: document.querySelector('input[name="paymentType"]:checked').value,
                monto_total: currentProduct.price,
                codigo_compra: purchaseCode,
                estado: 'pendiente',
                fecha_creacion: new Date().toISOString()
            };

            try {
                const comprasRec = await DB.get('compras');
                comprasRec.compras.push(formData);
                await DB.set('compras', comprasRec);

                if (formData.tipo_pago === 'financing') {
                    await createFinancingQuotas(formData.id, currentProduct.price);
                }

                await updateStock(currentProduct.id);
                redirectToWhatsApp(formData, purchaseCode);
            } catch (err) {
                console.error(err);
                alert('Error al procesar la compra. Intente nuevamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-whatsapp"></i> Confirmar';
            }
        }

        function generatePurchaseCode() {
            return 'LS-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        async function createFinancingQuotas(purchaseId, totalAmount) {
            const init = financingConfig.monto_inicial;
            const quotaAmount = (totalAmount - init) / financingConfig.numero_cuotas;
            const rec = await DB.get('cuotas');
            for (let i = 1; i <= financingConfig.numero_cuotas; i++) {
                const due = new Date();
                due.setDate(due.getDate() + financingConfig.dias_cuota * i);
                rec.cuotas.push({
                    id: uid() + i,
                    compra_id: purchaseId,
                    numero_cuota: i,
                    numero_cuotas: financingConfig.numero_cuotas,
                    monto: quotaAmount,
                    fecha_vencimiento: due.toISOString(),
                    estado: 'pendiente',
                    pagada: false
                });
            }
            await DB.set('cuotas', rec);
        }

        async function updateStock(productId) {
            const rec = await DB.get('productos');
            const product = rec.productos.find(p => p.id == productId);
            if (product) {
                product.stock = Math.max(0, product.stock - 1);
                if (product.stock <= 0) product.activo = false;
                await DB.set('productos', rec);
            }
        }

        function redirectToWhatsApp(formData, purchaseCode) {
            const msg = encodeURIComponent(
                `*NUEVA COMPRA - LenceriaShops*\n\n` +
                `üìã C√≥digo: ${purchaseCode}\n` +
                `üë§ Cliente: ${formData.nombre} ${formData.apellido}\n` +
                `üì± WhatsApp: ${formData.whatsapp}\n` +
                `üè¢ Direcci√≥n: Edif. ${formData.edificio}, Apto ${formData.apartamento}\n` +
                `üõçÔ∏è Producto: ${currentProduct.name}\n` +
                `üí∞ Total: $${parseFloat(formData.monto_total).toFixed(2)}\n` +
                `üí≥ Pago: ${formData.tipo_pago === 'financing' ? 'Financiamiento' : 'Pago Completo'}\n\n` +
                `Por favor confirme la compra para procesar el env√≠o.`
            );
            window.open(`https://wa.me/584129204453?text=${msg}`, '_blank');
            bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
            setTimeout(() => {
                alert('¬°Gracias! Tu orden fue enviada a WhatsApp para confirmaci√≥n.');
                loadProducts();
            }, 1000);
        }
    </script>
</body>
</html>
