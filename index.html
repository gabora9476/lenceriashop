<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LenceriaShops - Cat√°logo de Lencer√≠a</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="https://picsum.photos/seed/lenceriashops-favicon/32/32.jpg">
    <link rel="icon" type="image/png" sizes="16x16" href="https://picsum.photos/seed/lenceriashops-favicon/16/16.jpg">
    <link rel="icon" type="image/png" sizes="32x32" href="https://picsum.photos/seed/lenceriashops-favicon/32/32.jpg">
    <link rel="icon" type="image/png" sizes="96x96" href="https://picsum.photos/seed/lenceriashops-favicon/96/96.jpg">
    <link rel="apple-touch-icon" sizes="57x57" href="https://picsum.photos/seed/lenceriashops-favicon/57/57.jpg">
    <link rel="apple-touch-icon" sizes="60x60" href="https://picsum.photos/seed/lenceriashops-favicon/60/60.jpg">
    <link rel="apple-touch-icon" sizes="72x72" href="https://picsum.photos/seed/lenceriashops-favicon/72/72.jpg">
    <link rel="apple-touch-icon" sizes="76x76" href="https://picsum.photos/seed/lenceriashops-favicon/76/76.jpg">
    <link rel="apple-touch-icon" sizes="114x114" href="https://picsum.photos/seed/lenceriashops-favicon/114/114.jpg">
    <link rel="apple-touch-icon" sizes="120x120" href="https://picsum.photos/seed/lenceriashops-favicon/120/120.jpg">
    <link rel="apple-touch-icon" sizes="144x144" href="https://picsum.photos/seed/lenceriashops-favicon/144/144.jpg">
    <link rel="apple-touch-icon" sizes="152x152" href="https://picsum.photos/seed/lenceriashops-favicon/152/152.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="https://picsum.photos/seed/lenceriashops-favicon/180/180.jpg">
    
    <!-- Mobile App Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LenceriaShops">
    <meta name="application-name" content="LenceriaShops">
    <meta name="msapplication-TileColor" content="#d4a574">
    <meta name="msapplication-TileImage" content="https://picsum.photos/seed/lenceriashops-favicon/144/144.jpg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #d4a574;
            --secondary-color: #f5e6d3;
            --dark-color: #2c1810;
            --light-bg: #faf8f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
            display: flex;
            flex-direction: min-height: 100vh;
        }

        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: white !important;
        }

        .hero-section {
            background: linear-gradient(135deg, rgba(212,165,116,0.1), rgba(245,230,211,0.3));
            padding: 20px 0;
            text-align: center;
            margin-bottom: 20px;
        }

        .hero-section h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .hero-section p {
            margin-bottom: 0;
        }

        /* Category Filter Buttons */
        .category-filters {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .filter-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .filter-btn {
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(212,165,116,0.3);
        }

        .filter-btn i {
            font-size: 0.9rem;
        }

        .content-section {
            flex: 1;
            padding-bottom: 60px;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            height: 100%;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--secondary-color);
        }

        .product-image.sold {
            opacity: 0.7;
            filter: grayscale(20%);
        }

        .product-body {
            padding: 15px;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark-color);
        }

        .product-price {
            font-size: 1.3rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .stock-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            margin-bottom: 12px;
        }

        .stock-available {
            background: #d4edda;
            color: #155724;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .sold-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.5);
            transform: rotate(5deg);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: rotate(5deg) scale(1);
            }
            50% {
                transform: rotate(5deg) scale(1.05);
            }
            100% {
                transform: rotate(5deg) scale(1);
            }
        }

        .btn-buy {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-buy:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(212,165,116,0.4);
        }

        .btn-buy:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-buy:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .modal-content {
            border-radius: 20px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(212,165,116,0.25);
        }

        .payment-option {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            background: #faf8f5;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background: rgba(212,165,116,0.1);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .whatsapp-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #25d366;
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 25px;
            box-shadow: 0 5px 20px rgba(37,211,102,0.4);
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .whatsapp-btn:hover {
            transform: scale(1.1);
            color: white;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .pagination .page-link {
            color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 8px 12px;
        }

        .pagination .page-item.active .page-link {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .pagination .page-link:hover {
            color: white;
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 15px 0;
            margin-top: auto;
        }

        .footer small {
            font-size: 0.8rem;
        }

        .footer a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .hero-section h1 {
                font-size: 1.5rem;
            }
            
            .product-card {
                margin-bottom: 15px;
            }

            .filter-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }

            .filter-btn i {
                font-size: 0.8rem;
            }

            .product-image {
                height: 180px;
            }

            .product-body {
                padding: 12px;
            }

            .product-title {
                font-size: 1rem;
            }

            .product-price {
                font-size: 1.1rem;
            }

            .whatsapp-btn {
                width: 50px;
                height: 50px;
                font-size: 22px;
                bottom: 15px;
                right: 15px;
            }
        }

        .financing-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .financing-details.show {
            display: block;
        }

        .form-text-transform-hint {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .size-badge {
            background: var(--secondary-color);
            color: var(--dark-color);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .no-products {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-products i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-shop"></i> LenceriaShops
                </a>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container">
                <h1>Cat√°logo de Lencer√≠a Premium</h1>
                <p class="lead">Descubre nuestra exclusiva colecci√≥n por tama√±os</p>
            </div>
        </section>

        <!-- Products Section -->
        <section class="content-section">
            <div class="container">
                <!-- Category Filters -->
                <div class="category-filters">
                    <div class="filter-buttons-container">
                        <button class="filter-btn active" onclick="filterBySize('all')">
                            <i class="bi bi-grid-3x3-gap"></i> Todos
                        </button>
                        <button class="filter-btn" onclick="filterBySize('sabanas')">
                            <i class="bi bi-rulers"></i> Individual
                        </button>
                        <button class="filter-btn" onclick="filterBySize('cubrecamas')">
                            <i class="bi bi-arrows-angle-expand"></i> Matrimonial
                        </button>
                        <button class="filter-btn" onclick="filterBySize('almohadas')">
                            <i class="bi bi-arrows-fullscreen"></i> Queen
                        </button>
                        <button class="filter-btn" onclick="filterBySize('fundas')">
                            <i class="bi bi-aspect-ratio"></i> King
                        </button>
                    </div>
                </div>

                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando productos...</p>
                </div>
                
                <div class="row" id="productsContainer">
                    <!-- Products will be loaded here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="paginationContainer">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <small>&copy; 2024 LenceriaShops | Powered by: <a href="https://www.instagram.com/inkgstar" target="_blank">gstarINK</a></small>
            </div>
        </footer>
    </div>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Completar Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <input type="hidden" id="productId">
                        <input type="hidden" id="productPrice">
                        <input type="hidden" id="productName">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control text-capitalize" id="firstName" required>
                                <div class="form-text-transform-hint">Introduzca su nombre</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido *</label>
                                <input type="text" class="form-control text-capitalize" id="lastName" required>
                                <div class="form-text-transform-hint">Introduzca su apellido</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="whatsapp" placeholder="+58 422XXXXXXX" required>
                            <div class="form-text-transform-hint">Introduzca su n√∫mero de WhatsApp</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edificio *</label>
                                <input type="text" class="form-control text-uppercase" id="building" required>
                                <div class="form-text-transform-hint">Introduzca el nombre del edificio</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apartamento *</label>
                                <input type="text" class="form-control text-uppercase" id="apartment" required>
                                <div class="form-text-transform-hint">Introduzca el n√∫mero de apartamento</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">M√©todo de Pago *</label>
                            <div class="payment-option" data-payment="full">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFull" value="full" required>
                                    <label class="form-check-label" for="paymentFull">
                                        <strong>Pago Completo</strong>
                                        <p class="mb-0 text-muted small">Pagar el total del producto</p>
                                    </label>
                                </div>
                            </div>
                            <div class="payment-option" data-payment="financing">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFinancing" value="financing">
                                    <label class="form-check-label" for="paymentFinancing">
                                        <strong>Financiamiento</strong>
                                        <p class="mb-0 text-muted small">Pago inicial + cuotas quincenales</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="financing-details" id="financingDetails">
                            <h6>Detalles del Financiamiento</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Pago Inicial:</strong></p>
                                    <p class="h5 text-primary" id="initialAmount">$0</p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Cuota 1:</strong></p>
                                    <p class="h5 text-primary" id="quota1">$0</p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Cuota 2:</strong></p>
                                    <p class="h5 text-primary" id="quota2">$0</p>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Al continuar, ser√°s redirigido a WhatsApp para confirmar tu compra.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchase">
                        <i class="bi bi-whatsapp"></i> Confirmar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Support Button -->
    <a href="https://wa.me/584129204453?text=Hola%20LenceriaShops%2C%20necesito%20ayuda%20con%20mi%20compra.%20%C2%BFPodr%C3%ADan%20asistirme%3F" target="_blank" class="whatsapp-btn">
        <i class="bi bi-headset"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://ahcmnlibucwylgnotovj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoY21ubGlidWN3eWxnbm90b3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODY1NDcsImV4cCI6MjA3OTE2MjU0N30.1S7ZO2IdrsPoYBEEPK6z5_t4qVvkdc4cqNRjPhqtHuE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentProduct = null;
        let financingConfig = null;
        let allProducts = [];
        let currentFilter = 'all';
        let currentPage = 1;
        const productsPerPage = 15;

        // Size mapping from database categories to display names
        const sizeMapping = {
            'sabanas': 'Individual',
            'cubrecamas': 'Matrimonial',
            'almohadas': 'Queen',
            'fundas': 'King'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadFinancingConfig();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Payment type selection
            document.querySelectorAll('input[name="paymentType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.closest('.payment-option').classList.add('selected');
                    
                    if (this.value === 'financing') {
                        showFinancingDetails();
                    } else {
                        hideFinancingDetails();
                    }
                });
            });

            // Confirm purchase button
            document.getElementById('confirmPurchase').addEventListener('click', processPurchase);

            // WhatsApp input formatting
            document.getElementById('whatsapp').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0 && !value.startsWith('58')) {
                    value = '58' + value;
                }
                if (value.length >= 4) {
                    value = '+' + value.slice(0, 3) + ' ' + value.slice(3);
                }
                e.target.value = value;
            });

            // Auto-format text inputs
            setupTextFormatting();
        }

        // Setup text formatting for form inputs
        function setupTextFormatting() {
            // Format first letter uppercase for name and last name
            document.getElementById('firstName').addEventListener('input', function(e) {
                let value = e.target.value;
                if (value.length > 0) {
                    e.target.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                }
            });

            document.getElementById('lastName').addEventListener('input', function(e) {
                let value = e.target.value;
                if (value.length > 0) {
                    e.target.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                }
            });

            // Format uppercase for building and apartment
            document.getElementById('building').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            document.getElementById('apartment').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        }

        // Filter products by size
        function filterBySize(size) {
            currentFilter = size;
            currentPage = 1; // Reset to first page when filtering
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter and display products
            displayProducts();
        }

        // Load products from Supabase
        async function loadProducts() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                
                // Load all products (both active and inactive/sold)
                const { data: products, error } = await supabase
                    .from('productos')
                    .select('*')
                    .order('nombre');

                if (error) throw error;

                allProducts = products || [];
                displayProducts();
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('loadingSpinner').innerHTML = 
                    '<p class="text-danger">Error al cargar los productos. Por favor, recargue la p√°gina.</p>';
            }
        }

        // Display products with pagination
        function displayProducts() {
            const container = document.getElementById('productsContainer');
            
            // Filter products
            const filteredProducts = currentFilter === 'all' 
                ? allProducts 
                : allProducts.filter(product => product.categoria === currentFilter);
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const productsToShow = filteredProducts.slice(startIndex, endIndex);

            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-products">
                            <i class="bi bi-inbox"></i>
                            <h5>No hay productos disponibles</h5>
                            <p class="text-muted">Intenta con otra categor√≠a</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
                productsToShow.forEach(product => {
                    const isSold = !product.activo; // Changed logic: inactive = sold
                    const sizeName = sizeMapping[product.categoria] || product.categoria;

                    const productCard = `
                        <div class="col-md-6 col-lg-4">
                            <div class="product-card">
                                ${isSold ? '<div class="sold-badge">VENDIDO</div>' : ''}
                                <img src="${product.imagen || 'https://picsum.photos/seed/lenceria' + product.id + '/400/300'}" 
                                     alt="${product.nombre}" class="product-image ${isSold ? 'sold' : ''}">
                                <div class="product-body">
                                    <h5 class="product-title">${product.nombre}</h5>
                                    <p class="text-muted small">${product.descripcion || ''}</p>
                                    <span class="size-badge">${sizeName}</span>
                                    <div class="product-price">$${product.precio.toFixed(2)}</div>
                                    ${isSold ? 
                                        '<span class="stock-badge stock-low">Producto vendido</span>' : 
                                        (product.stock > 5 ? 
                                            '<span class="stock-badge stock-available">Disponible</span>' : 
                                            `<span class="stock-badge stock-low">¬°Solo ${product.stock} disponibles!</span>`)
                                    }
                                    <button class="btn btn-buy" onclick="openPurchaseModal(${product.id}, '${product.nombre}', ${product.precio})" 
                                            ${isSold || product.stock <= 0 ? 'disabled' : ''}>
                                        <i class="bi bi-cart-plus"></i> ${isSold ? 'No disponible' : 'Comprar'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += productCard;
                });
            }

            // Update pagination
            updatePagination(totalPages);
        }

        // Update pagination controls
        function updatePagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<nav><ul class="pagination">';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<li class="page-item disabled">
                        <a class="page-link" href="#">...</a>
                    </li>`;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>`;
            }

            paginationHTML += '</ul></nav>';
            paginationContainer.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayProducts();
            
            // Scroll to top of products
            document.querySelector('.content-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Load financing configuration
        async function loadFinancingConfig() {
            try {
                const { data: config, error } = await supabase
                    .from('configuracion')
                    .select('*')
                    .eq('clave', 'financiamiento')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                financingConfig = config ? config.valor : {
                    monto_inicial: 10,
                    numero_cuotas: 2,
                    dias_cuota: 15
                };
            } catch (error) {
                console.error('Error loading financing config:', error);
                financingConfig = {
                    monto_inicial: 10,
                    numero_cuotas: 2,
                    dias_cuota: 15
                };
            }
        }

        // Open purchase modal
        function openPurchaseModal(productId, productName, productPrice) {
            currentProduct = {
                id: productId,
                name: productName,
                price: productPrice
            };

            document.getElementById('productId').value = productId;
            document.getElementById('productName').value = productName;
            document.getElementById('productPrice').value = productPrice;

            // Reset form
            document.getElementById('purchaseForm').reset();
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            hideFinancingDetails();

            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            modal.show();
        }

        // Show financing details
        function showFinancingDetails() {
            const price = parseFloat(document.getElementById('productPrice').value);
            const initialAmount = financingConfig.monto_inicial;
            const remainingAmount = price - initialAmount;
            const quotaAmount = remainingAmount / financingConfig.numero_cuotas;

            document.getElementById('initialAmount').textContent = `$${initialAmount.toFixed(2)}`;
            document.getElementById('quota1').textContent = `$${quotaAmount.toFixed(2)}`;
            document.getElementById('quota2').textContent = `$${quotaAmount.toFixed(2)}`;
            
            document.getElementById('financingDetails').classList.add('show');
        }

        // Hide financing details
        function hideFinancingDetails() {
            document.getElementById('financingDetails').classList.remove('show');
        }

        // Process purchase
        async function processPurchase() {
            if (!validateForm()) return;

            const formData = {
                producto_id: currentProduct.id,
                nombre: document.getElementById('firstName').value,
                apellido: document.getElementById('lastName').value,
                whatsapp: document.getElementById('whatsapp').value,
                edificio: document.getElementById('building').value,
                apartamento: document.getElementById('apartment').value,
                tipo_pago: document.querySelector('input[name="paymentType"]:checked').value,
                monto_total: currentProduct.price,
                codigo_compra: generatePurchaseCode()
            };

            try {
                // Save purchase to database
                const { data: purchase, error } = await supabase
                    .from('compras')
                    .insert([formData])
                    .select()
                    .single();

                if (error) throw error;

                // If financing, create quotas
                if (formData.tipo_pago === 'financing') {
                    await createFinancingQuotas(purchase.id, currentProduct.price);
                }

                // Update stock
                await updateStock(currentProduct.id);

                // Redirect to WhatsApp
                redirectToWhatsApp(formData, purchase.codigo_compra);

            } catch (error) {
                console.error('Error processing purchase:', error);
                alert('Error al procesar la compra. Por favor, intente nuevamente.');
            }
        }

        // Validate form
        function validateForm() {
            const form = document.getElementById('purchaseForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            return true;
        }

        // Generate purchase code
        function generatePurchaseCode() {
            return 'LS-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // Create financing quotas
        async function createFinancingQuotas(purchaseId, totalAmount) {
            const initialAmount = financingConfig.monto_inicial;
            const remainingAmount = totalAmount - initialAmount;
            const quotaAmount = remainingAmount / financingConfig.numero_cuotas;

            const quotas = [];
            for (let i = 1; i <= financingConfig.numero_cuotas; i++) {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + (financingConfig.dias_cuota * i));
                
                quotas.push({
                    compra_id: purchaseId,
                    numero_cuota: i,
                    monto: quotaAmount,
                    fecha_vencimiento: dueDate.toISOString(),
                    estado: 'pendiente'
                });
            }

            const { error } = await supabase
                .from('cuotas')
                .insert(quotas);

            if (error) throw error;
        }

        // Update product stock
        async function updateStock(productId) {
            const { data: product, error: fetchError } = await supabase
                .from('productos')
                .select('stock')
                .eq('id', productId)
                .single();

            if (fetchError) throw fetchError;

            const { error: updateError } = await supabase
                .from('productos')
                .update({ stock: product.stock - 1 })
                .eq('id', productId);

            if (updateError) throw updateError;
        }

        // Redirect to WhatsApp
        function redirectToWhatsApp(formData, purchaseCode) {
            const message = encodeURIComponent(
                `*NUEVA COMPRA - LenceriaShops*\n\n` +
                `üìã C√≥digo de Compra: ${purchaseCode}\n` +
                `üë§ Cliente: ${formData.nombre} ${formData.apellido}\n` +
                `üì± WhatsApp: ${formData.whatsapp}\n` +
                `üè¢ Direcci√≥n: Edificio ${formData.edificio}, Apto ${formData.apartamento}\n` +
                `üõçÔ∏è Producto: ${currentProduct.name}\n` +
                `üí∞ Monto Total: $${formData.monto_total.toFixed(2)}\n` +
                `üí≥ Tipo de Pago: ${formData.tipo_pago === 'financing' ? 'Financiamiento' : 'Pago Completo'}\n\n` +
                `Por favor, confirme su compra para procesar el env√≠o.`
            );

            window.open(`https://wa.me/584129204453?text=${message}`, '_blank');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
            
            // Show success message
            setTimeout(() => {
                alert('¬°Gracias por su compra! Hemos enviado su orden a WhatsApp para confirmaci√≥n.');
                loadProducts(); // Reload products to update stock
            }, 1000);
        }
    </script>
</body>
</html>
