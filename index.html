<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LenceriaShops - Cat√°logo de Lencer√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #d4a574;
            --secondary-color: #f5e6d3;
            --dark-color: #2c1810;
            --light-bg: #faf8f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: white !important;
        }

        .hero-section {
            background: linear-gradient(135deg, rgba(212,165,116,0.1), rgba(245,230,211,0.3));
            padding: 60px 0;
            text-align: center;
            margin-bottom: 40px;
        }

        .hero-section h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 30px;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: var(--secondary-color);
        }

        .product-body {
            padding: 20px;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .product-price {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .stock-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .stock-available {
            background: #d4edda;
            color: #155724;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .btn-buy {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-buy:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(212,165,116,0.4);
        }

        .modal-content {
            border-radius: 20px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(212,165,116,0.25);
        }

        .payment-option {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            background: #faf8f5;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background: rgba(212,165,116,0.1);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .whatsapp-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #25d366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 5px 20px rgba(37,211,102,0.4);
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .whatsapp-btn:hover {
            transform: scale(1.1);
            color: white;
        }

        @media (max-width: 768px) {
            .hero-section h1 {
                font-size: 2rem;
            }
            
            .product-card {
                margin-bottom: 20px;
            }
        }

        .financing-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .financing-details.show {
            display: block;
        }

        .form-text-transform-hint {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shop"></i> LenceriaShops
            </a>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <h1>Cat√°logo de Lencer√≠a Premium</h1>
            <p class="lead">Descubre nuestra exclusiva colecci√≥n de s√°banas y cubrecamas</p>
        </div>
    </section>

    <!-- Products Section -->
    <section class="container mb-5">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando productos...</p>
        </div>
        
        <div class="row" id="productsContainer">
            <!-- Products will be loaded here -->
        </div>
    </section>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Completar Compra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <input type="hidden" id="productId">
                        <input type="hidden" id="productPrice">
                        <input type="hidden" id="productName">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control text-capitalize" id="firstName" required>
                                <div class="form-text-transform-hint">La primera letra se convertir√° autom√°ticamente a may√∫scula</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido *</label>
                                <input type="text" class="form-control text-capitalize" id="lastName" required>
                                <div class="form-text-transform-hint">La primera letra se convertir√° autom√°ticamente a may√∫scula</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">WhatsApp *</label>
                            <input type="tel" class="form-control" id="whatsapp" placeholder="+58 422XXXXXXX" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edificio *</label>
                                <input type="text" class="form-control text-uppercase" id="building" required>
                                <div class="form-text-transform-hint">Se convertir√° autom√°ticamente a may√∫sculas</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apartamento *</label>
                                <input type="text" class="form-control text-uppercase" id="apartment" required>
                                <div class="form-text-transform-hint">Se convertir√° autom√°ticamente a may√∫sculas</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">M√©todo de Pago *</label>
                            <div class="payment-option" data-payment="full">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFull" value="full" required>
                                    <label class="form-check-label" for="paymentFull">
                                        <strong>Pago Completo</strong>
                                        <p class="mb-0 text-muted small">Pagar el total del producto</p>
                                    </label>
                                </div>
                            </div>
                            <div class="payment-option" data-payment="financing">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentType" id="paymentFinancing" value="financing">
                                    <label class="form-check-label" for="paymentFinancing">
                                        <strong>Financiamiento</strong>
                                        <p class="mb-0 text-muted small">50% inicial + 2 cuotas quincenales</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="financing-details" id="financingDetails">
                            <h6>Detalles del Financiamiento</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Inicial (50%):</strong></p>
                                    <p class="h5 text-primary" id="initialAmount">$0</p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Cuota 1:</strong></p>
                                    <p class="h5 text-primary" id="quota1">$0</p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1"><strong>Cuota 2:</strong></p>
                                    <p class="h5 text-primary" id="quota2">$0</p>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Al continuar, ser√°s redirigido a WhatsApp para confirmar tu compra.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchase">
                        <i class="bi bi-whatsapp"></i> Confirmar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Support Button -->
    <a href="https://wa.me/584129204453?text=Hola%20LenceriaShops%2C%20necesito%20ayuda%20con%20mi%20compra.%20%C2%BFPodr%C3%ADan%20asistirme%3F" target="_blank" class="whatsapp-btn">
        <i class="bi bi-headset"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://ahcmnlibucwylgnotovj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoY21ubGlidWN3eWxnbm90b3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODY1NDcsImV4cCI6MjA3OTE2MjU0N30.1S7ZO2IdrsPoYBEEPK6z5_t4qVvkdc4cqNRjPhqtHuE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentProduct = null;
        let financingConfig = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadFinancingConfig();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Payment type selection
            document.querySelectorAll('input[name="paymentType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.closest('.payment-option').classList.add('selected');
                    
                    if (this.value === 'financing') {
                        showFinancingDetails();
                    } else {
                        hideFinancingDetails();
                    }
                });
            });

            // Confirm purchase button
            document.getElementById('confirmPurchase').addEventListener('click', processPurchase);

            // WhatsApp input formatting
            document.getElementById('whatsapp').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0 && !value.startsWith('58')) {
                    value = '58' + value;
                }
                if (value.length >= 4) {
                    value = '+' + value.slice(0, 3) + ' ' + value.slice(3);
                }
                e.target.value = value;
            });

            // Auto-format text inputs
            setupTextFormatting();
        }

        // Setup text formatting for form inputs
        function setupTextFormatting() {
            // Format first letter uppercase for name and last name
            document.getElementById('firstName').addEventListener('input', function(e) {
                let value = e.target.value;
                if (value.length > 0) {
                    e.target.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                }
            });

            document.getElementById('lastName').addEventListener('input', function(e) {
                let value = e.target.value;
                if (value.length > 0) {
                    e.target.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
                }
            });

            // Format uppercase for building and apartment
            document.getElementById('building').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            document.getElementById('apartment').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        }

        // Load products from Supabase
        async function loadProducts() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                
                const { data: products, error } = await supabase
                    .from('productos')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;

                displayProducts(products);
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('loadingSpinner').innerHTML = 
                    '<p class="text-danger">Error al cargar los productos. Por favor, recargue la p√°gina.</p>';
            }
        }

        // Display products
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';

            products.forEach(product => {
                const stockClass = product.stock > 5 ? 'stock-available' : 'stock-low';
                const stockText = product.stock > 5 ? 'Disponible' : `¬°Solo ${product.stock} disponibles!`;

                const productCard = `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card">
                            <img src="${product.imagen || 'https://picsum.photos/seed/lenceria${product.id}/400/300'}" 
                                 alt="${product.nombre}" class="product-image">
                            <div class="product-body">
                                <h5 class="product-title">${product.nombre}</h5>
                                <p class="text-muted small">${product.descripcion || ''}</p>
                                <div class="product-price">$${product.precio.toFixed(2)}</div>
                                <span class="stock-badge ${stockClass}">${stockText}</span>
                                <button class="btn btn-buy" onclick="openPurchaseModal(${product.id}, '${product.nombre}', ${product.precio})" 
                                        ${product.stock <= 0 ? 'disabled' : ''}>
                                    <i class="bi bi-cart-plus"></i> Comprar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        }

        // Load financing configuration
        async function loadFinancingConfig() {
            try {
                const { data: config, error } = await supabase
                    .from('configuracion')
                    .select('*')
                    .eq('clave', 'financiamiento')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                financingConfig = config ? config.valor : {
                    porcentaje_inicial: 50,
                    numero_cuotas: 2,
                    dias_cuota: 15
                };
            } catch (error) {
                console.error('Error loading financing config:', error);
                financingConfig = {
                    porcentaje_inicial: 50,
                    numero_cuotas: 2,
                    dias_cuota: 15
                };
            }
        }

        // Open purchase modal
        function openPurchaseModal(productId, productName, productPrice) {
            currentProduct = {
                id: productId,
                name: productName,
                price: productPrice
            };

            document.getElementById('productId').value = productId;
            document.getElementById('productName').value = productName;
            document.getElementById('productPrice').value = productPrice;

            // Reset form
            document.getElementById('purchaseForm').reset();
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            hideFinancingDetails();

            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            modal.show();
        }

        // Show financing details
        function showFinancingDetails() {
            const price = parseFloat(document.getElementById('productPrice').value);
            const initialPercent = financingConfig.porcentaje_inicial / 100;
            const remainingAmount = price * (1 - initialPercent);
            const quotaAmount = remainingAmount / financingConfig.numero_cuotas;

            document.getElementById('initialAmount').textContent = `$${(price * initialPercent).toFixed(2)}`;
            document.getElementById('quota1').textContent = `$${quotaAmount.toFixed(2)}`;
            document.getElementById('quota2').textContent = `$${quotaAmount.toFixed(2)}`;
            
            document.getElementById('financingDetails').classList.add('show');
        }

        // Hide financing details
        function hideFinancingDetails() {
            document.getElementById('financingDetails').classList.remove('show');
        }

        // Process purchase
        async function processPurchase() {
            if (!validateForm()) return;

            const formData = {
                producto_id: currentProduct.id,
                nombre: document.getElementById('firstName').value,
                apellido: document.getElementById('lastName').value,
                whatsapp: document.getElementById('whatsapp').value,
                edificio: document.getElementById('building').value,
                apartamento: document.getElementById('apartment').value,
                tipo_pago: document.querySelector('input[name="paymentType"]:checked').value,
                monto_total: currentProduct.price,
                codigo_compra: generatePurchaseCode()
            };

            try {
                // Save purchase to database
                const { data: purchase, error } = await supabase
                    .from('compras')
                    .insert([formData])
                    .select()
                    .single();

                if (error) throw error;

                // If financing, create quotas
                if (formData.tipo_pago === 'financing') {
                    await createFinancingQuotas(purchase.id, currentProduct.price);
                }

                // Update stock
                await updateStock(currentProduct.id);

                // Redirect to WhatsApp
                redirectToWhatsApp(formData, purchase.codigo_compra);

            } catch (error) {
                console.error('Error processing purchase:', error);
                alert('Error al procesar la compra. Por favor, intente nuevamente.');
            }
        }

        // Validate form
        function validateForm() {
            const form = document.getElementById('purchaseForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            return true;
        }

        // Generate purchase code
        function generatePurchaseCode() {
            return 'LS-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // Create financing quotas
        async function createFinancingQuotas(purchaseId, totalAmount) {
            const initialPercent = financingConfig.porcentaje_inicial / 100;
            const remainingAmount = totalAmount * (1 - initialPercent);
            const quotaAmount = remainingAmount / financingConfig.numero_cuotas;

            const quotas = [];
            for (let i = 1; i <= financingConfig.numero_cuotas; i++) {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + (financingConfig.dias_cuota * i));
                
                quotas.push({
                    compra_id: purchaseId,
                    numero_cuota: i,
                    monto: quotaAmount,
                    fecha_vencimiento: dueDate.toISOString(),
                    estado: 'pendiente'
                });
            }

            const { error } = await supabase
                .from('cuotas')
                .insert(quotas);

            if (error) throw error;
        }

        // Update product stock
        async function updateStock(productId) {
            const { data: product, error: fetchError } = await supabase
                .from('productos')
                .select('stock')
                .eq('id', productId)
                .single();

            if (fetchError) throw fetchError;

            const { error: updateError } = await supabase
                .from('productos')
                .update({ stock: product.stock - 1 })
                .eq('id', productId);

            if (updateError) throw updateError;
        }

        // Redirect to WhatsApp
        function redirectToWhatsApp(formData, purchaseCode) {
            const message = encodeURIComponent(
                `*NUEVA COMPRA - LenceriaShops*\n\n` +
                `üìã C√≥digo de Compra: ${purchaseCode}\n` +
                `üë§ Cliente: ${formData.nombre} ${formData.apellido}\n` +
                `üì± WhatsApp: ${formData.whatsapp}\n` +
                `üè¢ Direcci√≥n: Edificio ${formData.edificio}, Apto ${formData.apartamento}\n` +
                `üõçÔ∏è Producto: ${currentProduct.name}\n` +
                `üí∞ Monto Total: $${formData.monto_total.toFixed(2)}\n` +
                `üí≥ Tipo de Pago: ${formData.tipo_pago === 'financing' ? 'Financiamiento' : 'Pago Completo'}\n\n` +
                `Por favor, confirme su compra para procesar el env√≠o.`
            );

            window.open(`https://wa.me/584129204453?text=${message}`, '_blank');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
            
            // Show success message
            setTimeout(() => {
                alert('¬°Gracias por su compra! Hemos enviado su orden a WhatsApp para confirmaci√≥n.');
                loadProducts(); // Reload products to update stock
            }, 1000);
        }
    </script>
</body>
</html>
